#!/bin/bash

# defaults go here
INSTANCE_ID=i-0c3f8d38432e5eb1d

while getopts 'h:' opt; do
  case "$opt" in
    h)
      HOST="$OPTARG"
      ;;
  esac
done
shift "$(($OPTIND -1))"

INSTANCE_ID=$(jq --arg HOST "$HOST" '."ssh-host"[$HOST]."instance-id"' ~/.aws/ec2-ssh.json | sed -e 's/"//g')

STATE=$(aws ec2 describe-instances --instance-ids $INSTANCE_ID --query 'Reservations[*].Instances[*].State.Code' --output text)

if [ "$STATE" != "16" ]; then
  echo "Instance $INSTANCE_ID not running! Exiting."
  exit 1
fi

aws ec2 stop-instances --instance-ids $INSTANCE_ID > /dev/null 2>&1
echo "Stopping EC2 $INSTANCE_ID"
